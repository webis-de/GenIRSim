<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>GenIRSim</title>
<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/editor.css">
<link rel="stylesheet" href="css/chat.css">
<link rel="stylesheet" href="css/messages.css">
<link rel="stylesheet" href="css/loader.css">
</head>
<body>

<h1>GenIRSim</h1>
<main>

<details id="configuration" class="pane" open><summary><h2>Configuration</h2></summary>
<div class="drop-zone" data-target="configuration"><select id="configurationSelect"><option>pick</option></select> or upload: drop here or <label for="configurationPicker">browse</label><input type="file" id="configurationPicker" name="configuration" accept="text/plain, application/json"></div>
<div class="buttons">Download:
<button id="downloadConfiguration" type="button">complete</button><button id="downloadConfigurationSimulation" type="button">simulation</button><button id="downloadConfigurationEvaluation" type="button">evaluation</button></div>
<div id="editor"></div>
</details> <!-- #configuration -->

<div id="simulation" class="pane"><h2>Simulation</h2>
<div class="drop-zone" data-target="simulation">upload: drop here or <label for="simulationPicker">browse</label><input type="file" id="simulationPicker" name="simulation" accept="text/plain, application/json"></div>
<div class="run-buttons" class="buttons">Run:
<button id="run" type="button">complete</button><button id="runSimulation" type="button">simulation</button><button id="runEvaluation" type="button">evaluation</button></div>
<div id="chat" class="area"></div>
</div> <!-- #simulation -->

<details id="log" class="pane" open><summary><h2>Log</h2></summary>
<div id="messages" class="area"></div>
</details> <!-- #log -->

</main>
<script type="module">
import * as configuration from "./js/configuration.js";
import * as simulation from "./js/simulation.js";
import * as dropZone from "./js/drop-zone.js";

const configurationDropZone = document.querySelector(".drop-zone[data-target='configuration']");
dropZone.createDropZone(configurationDropZone, configuration.load);

const simulationDropZone = document.querySelector(".drop-zone[data-target='simulation']");
dropZone.createDropZone(simulationDropZone, simulation.load);

document.getElementById("downloadConfiguration").addEventListener("click",
  () => configuration.download(configuration.get()));
document.getElementById("downloadConfigurationSimulation").addEventListener("click",
  () => configuration.download(configuration.get().simulation, "-simulation"));
document.getElementById("downloadConfigurationEvaluation").addEventListener("click",
  () => configuration.download(configuration.get().evaluation, "-evaluation"));

document.getElementById("run").addEventListener("click",
  () => simulation.run("run", configuration.get()));
document.getElementById("runSimulation").addEventListener("click",
  () => simulation.run("simulate", configuration.get().simulation));
document.getElementById("runEvaluation").addEventListener("click",
  () => simulation.run("evaluate", configuration.get().evaluation));
document.getElementById("runEvaluation").setAttribute("disabled", "");

const configurationDirectory = "configurations";
const defaultConfiguration = "discussion.json"
configuration.loadFromUrl(configurationDirectory + "/" + defaultConfiguration);
fetch(configurationDirectory)
  .then(response => response.json())
  .then(configurationFiles => {
      const configurationSelectElement = document.getElementById("configurationSelect");
      for (const configurationFile of configurationFiles) {
        const optionElement = document.createElement("option");
        optionElement.innerText = configurationFile.split(".")[0];
        optionElement.setAttribute("value", configurationFile);
        configurationSelectElement.appendChild(optionElement);
      }
      configurationSelectElement.addEventListener("change", async event => {
        const value = configurationSelectElement.value;
        if (value.match("\.json$")) {
          const success = await configuration.loadFromUrl(configurationDirectory + "/" + value);
          dropZone.fade(configurationDropZone, success);
          setTimeout(() => {
            configurationSelectElement.value = "pick";
          }, 500);
        }
      });
    });
</script>
</body>
</html>
